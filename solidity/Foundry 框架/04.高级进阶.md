# Foundry é«˜çº§è¿›é˜¶ï¼ˆ3-4å¤©ï¼‰

## ğŸ§© æ’ä»¶å¼€å‘

### è‡ªå®šä¹‰æµ‹è¯•åŒ¹é…å™¨
```solidity
library AdvancedMatchers {
    function assertBalanceEq(address token, address account, uint256 expected) internal {
        uint256 actual = ERC20(token).balanceOf(account);
        if (actual != expected) {
            emit log_string("Balance mismatch");
            fail();
        }
    }
}

// åœ¨æµ‹è¯•åˆçº¦ä¸­ä½¿ç”¨
using {AdvancedMatchers.assertBalanceEq} for address;
```

### éƒ¨ç½²æµç¨‹æ‰©å±•
```solidity
contract DeployHook is Script {
    function run() external {
        // é¢„éƒ¨ç½²æ£€æŸ¥
        if (block.chainid != 1) revert("Mainnet only");
        
        vm.startBroadcast();
        MyContract instance = new MyContract();
        vm.stopBroadcast();

        // åéƒ¨ç½²éªŒè¯
        require(instance.version() == 1.0, "Version mismatch");
    }
}
```

## ğŸ›¡ï¸ å®‰å…¨å®¡è®¡

### é™æ€åˆ†æå·¥å…·
```bash
forge audit --level high
```
è¾“å‡ºç¤ºä¾‹ï¼š
```
[High] Reentrancy in Withdraw Function
File: src/Vault.sol
Line: 45-52
Pattern: state change after external call
```

### æ¼æ´æ¨¡å¼æ£€æµ‹
```solidity
contract UnsafeBank {
    mapping(address => uint) balances;
    
    function withdraw() public {
        (bool success, ) = msg.sender.call{value: balances[msg.sender]}("");
        require(success);
        balances[msg.sender] = 0; // é£é™©ç‚¹ï¼šçŠ¶æ€æ›´æ–°åœ¨å¤–éƒ¨è°ƒç”¨ä¹‹å
    }
}
```

## ğŸ”„ å‡çº§æ¨¡å¼

### é€æ˜ä»£ç†æ¶æ„
```solidity
contract Proxy {
    address implementation;
    
    fallback() external payable {
        assembly {
            let ptr := mload(0x40)
            calldatacopy(ptr, 0, calldatasize())
            let result := delegatecall(gas(), sload(implementation.slot), ptr, calldatasize(), 0, 0)
            returndatacopy(0, 0, returndatasize())
            if iszero(result) { revert(0, returndatasize()) }
            return(0, returndatasize())
        }
    }
}
```

### ç‰ˆæœ¬è¿ç§»ç­–ç•¥
```solidity
contract V2Migration is Script {
    function run() external {
        address proxy = 0x1234...;
        
        vm.startBroadcast();
        V2Implementation newImpl = new V2Implementation();
        Proxy(proxy).upgradeTo(address(newImpl));
        
        // æ•°æ®è¿ç§»
        V2Implementation(proxy).migrateStorage();
        vm.stopBroadcast();
    }
}
```

## å­¦ä¹ éªŒè¯æ ‡å‡†
1. èƒ½å¼€å‘ç¬¦åˆ Foundry æ ‡å‡†çš„æ’ä»¶æ¨¡å—
2. èƒ½é€šè¿‡é™æ€åˆ†æå‘ç°é«˜é£é™©æ¼æ´
3. èƒ½å®æ–½å®Œæ•´çš„åˆçº¦å‡çº§æµç¨‹
4. èƒ½è®¾è®¡é˜²æ•°æ®ä¸¢å¤±çš„è¿ç§»æ–¹æ¡ˆ

## è¿›é˜¶å®è·µæ¡ˆä¾‹

### è·¨æ’ä»¶é›†æˆ
```toml
[plugins]
security = "src/plugins/SecurityChecker.sol"
deploy = "script/DeployHooks.sol"
```

### è‡ªåŠ¨åŒ–å®¡è®¡æµæ°´çº¿
```bash
#!/bin/bash
forge build &&
forge audit --level medium > audit.md &&
slither . --checklist > slither.md &&
forge test --gas-report
```

## å¸¸è§é—®é¢˜æ’æŸ¥
1. ä»£ç†åˆçº¦å­˜å‚¨å†²çªï¼šä½¿ç”¨ `forge inspect storage-layout`
2. æ’ä»¶å…¼å®¹æ€§é—®é¢˜ï¼šæ£€æŸ¥ Foundry ç‰ˆæœ¬ `forge --version`
3. è¿ç§»æ•°æ®ä¸¢å¤±ï¼šä½¿ç”¨ `vm.load`/`vm.store` è°ƒè¯•å­˜å‚¨æ§½
4. é™æ€åˆ†æè¯¯æŠ¥ï¼šé…ç½® `.slither.config.json` è¿‡æ»¤è§„åˆ™

å»ºè®®å®è·µé¡ºåºï¼š
1. ä»£ç†åˆçº¦éƒ¨ç½² â†’ 2. æ¼æ´æ¨¡å¼å®éªŒ â†’ 3. æ’ä»¶å¼€å‘ â†’ 4. è‡ªåŠ¨åŒ–å‡çº§ â†’ 5. å…¨é“¾è·¯å®¡è®¡