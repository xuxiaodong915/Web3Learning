# Foundry 高级进阶（3-4天）

## 🧩 插件开发

### 自定义测试匹配器
```solidity
library AdvancedMatchers {
    function assertBalanceEq(address token, address account, uint256 expected) internal {
        uint256 actual = ERC20(token).balanceOf(account);
        if (actual != expected) {
            emit log_string("Balance mismatch");
            fail();
        }
    }
}

// 在测试合约中使用
using {AdvancedMatchers.assertBalanceEq} for address;
```

### 部署流程扩展
```solidity
contract DeployHook is Script {
    function run() external {
        // 预部署检查
        if (block.chainid != 1) revert("Mainnet only");
        
        vm.startBroadcast();
        MyContract instance = new MyContract();
        vm.stopBroadcast();

        // 后部署验证
        require(instance.version() == 1.0, "Version mismatch");
    }
}
```

## 🛡️ 安全审计

### 静态分析工具
```bash
forge audit --level high
```
输出示例：
```
[High] Reentrancy in Withdraw Function
File: src/Vault.sol
Line: 45-52
Pattern: state change after external call
```

### 漏洞模式检测
```solidity
contract UnsafeBank {
    mapping(address => uint) balances;
    
    function withdraw() public {
        (bool success, ) = msg.sender.call{value: balances[msg.sender]}("");
        require(success);
        balances[msg.sender] = 0; // 风险点：状态更新在外部调用之后
    }
}
```

## 🔄 升级模式

### 透明代理架构
```solidity
contract Proxy {
    address implementation;
    
    fallback() external payable {
        assembly {
            let ptr := mload(0x40)
            calldatacopy(ptr, 0, calldatasize())
            let result := delegatecall(gas(), sload(implementation.slot), ptr, calldatasize(), 0, 0)
            returndatacopy(0, 0, returndatasize())
            if iszero(result) { revert(0, returndatasize()) }
            return(0, returndatasize())
        }
    }
}
```

### 版本迁移策略
```solidity
contract V2Migration is Script {
    function run() external {
        address proxy = 0x1234...;
        
        vm.startBroadcast();
        V2Implementation newImpl = new V2Implementation();
        Proxy(proxy).upgradeTo(address(newImpl));
        
        // 数据迁移
        V2Implementation(proxy).migrateStorage();
        vm.stopBroadcast();
    }
}
```

## 学习验证标准
1. 能开发符合 Foundry 标准的插件模块
2. 能通过静态分析发现高风险漏洞
3. 能实施完整的合约升级流程
4. 能设计防数据丢失的迁移方案

## 进阶实践案例

### 跨插件集成
```toml
[plugins]
security = "src/plugins/SecurityChecker.sol"
deploy = "script/DeployHooks.sol"
```

### 自动化审计流水线
```bash
#!/bin/bash
forge build &&
forge audit --level medium > audit.md &&
slither . --checklist > slither.md &&
forge test --gas-report
```

## 常见问题排查
1. 代理合约存储冲突：使用 `forge inspect storage-layout`
2. 插件兼容性问题：检查 Foundry 版本 `forge --version`
3. 迁移数据丢失：使用 `vm.load`/`vm.store` 调试存储槽
4. 静态分析误报：配置 `.slither.config.json` 过滤规则

建议实践顺序：
1. 代理合约部署 → 2. 漏洞模式实验 → 3. 插件开发 → 4. 自动化升级 → 5. 全链路审计