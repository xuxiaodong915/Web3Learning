# Foundry 核心功能深入（2-3天）

## 🔧 测试框架进阶

### 单元测试规范
```solidity
// SPDX-License-Identifier: MIT
pragma solidity ^0.8.20;

import "forge-std/Test.sol";
import "../src/MyERC20.sol";

contract ERC20Test is Test {
    MyERC20 token;
    address user = vm.addr(1);

    function setUp() public {
        token = new MyERC20("Test", "TST");
    }

    function test_Mint() public {
        token.mint(user, 100 ether);
        assertEq(token.balanceOf(user), 100 ether);
        vm.expectEmit(true, true, true, true);
        emit Transfer(address(0), user, 100 ether);
    }
}
```

### 模糊测试（Fuzz Testing）
```solidity
function testTransferFuzz(uint256 amount) public {
    vm.assume(amount <= 100 ether); // 设置参数边界
    token.mint(user, amount);
    
    vm.prank(user);
    token.transfer(address(this), amount);
    assertEq(token.balanceOf(address(this)), amount);
}
```
```bash
forge test --match-test testTransferFuzz -vvv
```

### 差分测试（Diff Testing）
```solidity
contract DiffTest {
    function test_SafeMath(uint256 x, uint256 y) public {
        // 对比不同实现的安全数学库
        assert(OriginalMath.add(x, y) == SafeMath.add(x, y));
    }
}
```

## ⛽ Gas优化分析

### Gas报告生成
```bash
forge test --gas-report
```
示例报告：
```
| Function Name         | min     | avg     | median  | max    | # calls |
|-----------------------|---------|---------|---------|--------|---------|
| ERC20.transfer        | 28345   | 28345   | 28345   | 28345  | 12      |
| ERC20.approve         | 24567   | 24567   | 24567   | 24567  | 8       |
```

### 优化模式实践
```solidity
// 使用库函数减少字节码大小
using SafeERC20 for address;

// 合并存储槽
struct Balance {
    uint256 amount;
    uint256 lastUpdated;
}

// 内联汇编优化
function _transfer(address to, uint256 amount) internal {
    assembly {
        // 优化后的汇编逻辑
    }
}
```

## 🚀 部署与交互

### 部署脚本编写
```solidity
contract DeployScript is Script {
    function run() external {
        uint256 deployerPrivateKey = vm.envUint("PRIVATE_KEY");
        vm.startBroadcast(deployerPrivateKey);
        
        MyERC20 token = new MyERC20("Gold", "GLD");
        console.log("Token deployed at:", address(token));

        vm.stopBroadcast();
    }
}
```

### 多链部署配置
```toml:foundry.toml
[etherscan]
mainnet = { key = "${MAINNET_API_KEY}" }
optimism = { key = "${OPTIMISM_API_KEY}" }

[rpc_endpoints]
mainnet = "https://eth-mainnet.g.alchemy.com/v2/YOUR_KEY"
optimism = "https://opt-mainnet.g.alchemy.com/v2/YOUR_KEY"
```

### Cast多链交互
```bash
# 主网查询
cast call 0xToken "balanceOf(address)" 0xUser --rpc-url mainnet

# Optimism 转账
cast send 0xToken "transfer(address,uint256)" 0xTo 100ether \
  --rpc-url optimism \
  --private-key $PRIVATE_KEY
```

## 学习验证标准
1. 能编写覆盖率达到85%的测试套件
2. 能将合约Gas消耗降低20%以上
3. 能完成多链部署并验证合约状态
4. 能诊断并修复常见的测试失败问题

## 常见问题排查
1. 模糊测试失败：使用`-vvvv`查看详细执行路径
2. Gas报告未生成：检查合约是否实际被调用
3. 多链部署失败：验证chainid配置是否正确
4. 差分测试不一致：使用`--ffi`进行外部数据对比

建议实践顺序：
1. 模糊测试 → 2. Gas优化 → 3. 单链部署 → 4. 多链交互 → 5. 全流程演练