# Foundry æ ¸å¿ƒåŠŸèƒ½æ·±å…¥ï¼ˆ2-3å¤©ï¼‰

## ğŸ”§ æµ‹è¯•æ¡†æ¶è¿›é˜¶

### å•å…ƒæµ‹è¯•è§„èŒƒ
```solidity
// SPDX-License-Identifier: MIT
pragma solidity ^0.8.20;

import "forge-std/Test.sol";
import "../src/MyERC20.sol";

contract ERC20Test is Test {
    MyERC20 token;
    address user = vm.addr(1);

    function setUp() public {
        token = new MyERC20("Test", "TST");
    }

    function test_Mint() public {
        token.mint(user, 100 ether);
        assertEq(token.balanceOf(user), 100 ether);
        vm.expectEmit(true, true, true, true);
        emit Transfer(address(0), user, 100 ether);
    }
}
```

### æ¨¡ç³Šæµ‹è¯•ï¼ˆFuzz Testingï¼‰
```solidity
function testTransferFuzz(uint256 amount) public {
    vm.assume(amount <= 100 ether); // è®¾ç½®å‚æ•°è¾¹ç•Œ
    token.mint(user, amount);
    
    vm.prank(user);
    token.transfer(address(this), amount);
    assertEq(token.balanceOf(address(this)), amount);
}
```
```bash
forge test --match-test testTransferFuzz -vvv
```

### å·®åˆ†æµ‹è¯•ï¼ˆDiff Testingï¼‰
```solidity
contract DiffTest {
    function test_SafeMath(uint256 x, uint256 y) public {
        // å¯¹æ¯”ä¸åŒå®ç°çš„å®‰å…¨æ•°å­¦åº“
        assert(OriginalMath.add(x, y) == SafeMath.add(x, y));
    }
}
```

## â›½ Gasä¼˜åŒ–åˆ†æ

### GasæŠ¥å‘Šç”Ÿæˆ
```bash
forge test --gas-report
```
ç¤ºä¾‹æŠ¥å‘Šï¼š
```
| Function Name         | min     | avg     | median  | max    | # calls |
|-----------------------|---------|---------|---------|--------|---------|
| ERC20.transfer        | 28345   | 28345   | 28345   | 28345  | 12      |
| ERC20.approve         | 24567   | 24567   | 24567   | 24567  | 8       |
```

### ä¼˜åŒ–æ¨¡å¼å®è·µ
```solidity
// ä½¿ç”¨åº“å‡½æ•°å‡å°‘å­—èŠ‚ç å¤§å°
using SafeERC20 for address;

// åˆå¹¶å­˜å‚¨æ§½
struct Balance {
    uint256 amount;
    uint256 lastUpdated;
}

// å†…è”æ±‡ç¼–ä¼˜åŒ–
function _transfer(address to, uint256 amount) internal {
    assembly {
        // ä¼˜åŒ–åçš„æ±‡ç¼–é€»è¾‘
    }
}
```

## ğŸš€ éƒ¨ç½²ä¸äº¤äº’

### éƒ¨ç½²è„šæœ¬ç¼–å†™
```solidity
contract DeployScript is Script {
    function run() external {
        uint256 deployerPrivateKey = vm.envUint("PRIVATE_KEY");
        vm.startBroadcast(deployerPrivateKey);
        
        MyERC20 token = new MyERC20("Gold", "GLD");
        console.log("Token deployed at:", address(token));

        vm.stopBroadcast();
    }
}
```

### å¤šé“¾éƒ¨ç½²é…ç½®
```toml:foundry.toml
[etherscan]
mainnet = { key = "${MAINNET_API_KEY}" }
optimism = { key = "${OPTIMISM_API_KEY}" }

[rpc_endpoints]
mainnet = "https://eth-mainnet.g.alchemy.com/v2/YOUR_KEY"
optimism = "https://opt-mainnet.g.alchemy.com/v2/YOUR_KEY"
```

### Castå¤šé“¾äº¤äº’
```bash
# ä¸»ç½‘æŸ¥è¯¢
cast call 0xToken "balanceOf(address)" 0xUser --rpc-url mainnet

# Optimism è½¬è´¦
cast send 0xToken "transfer(address,uint256)" 0xTo 100ether \
  --rpc-url optimism \
  --private-key $PRIVATE_KEY
```

## å­¦ä¹ éªŒè¯æ ‡å‡†
1. èƒ½ç¼–å†™è¦†ç›–ç‡è¾¾åˆ°85%çš„æµ‹è¯•å¥—ä»¶
2. èƒ½å°†åˆçº¦Gasæ¶ˆè€—é™ä½20%ä»¥ä¸Š
3. èƒ½å®Œæˆå¤šé“¾éƒ¨ç½²å¹¶éªŒè¯åˆçº¦çŠ¶æ€
4. èƒ½è¯Šæ–­å¹¶ä¿®å¤å¸¸è§çš„æµ‹è¯•å¤±è´¥é—®é¢˜

## å¸¸è§é—®é¢˜æ’æŸ¥
1. æ¨¡ç³Šæµ‹è¯•å¤±è´¥ï¼šä½¿ç”¨`-vvvv`æŸ¥çœ‹è¯¦ç»†æ‰§è¡Œè·¯å¾„
2. GasæŠ¥å‘Šæœªç”Ÿæˆï¼šæ£€æŸ¥åˆçº¦æ˜¯å¦å®é™…è¢«è°ƒç”¨
3. å¤šé“¾éƒ¨ç½²å¤±è´¥ï¼šéªŒè¯chainidé…ç½®æ˜¯å¦æ­£ç¡®
4. å·®åˆ†æµ‹è¯•ä¸ä¸€è‡´ï¼šä½¿ç”¨`--ffi`è¿›è¡Œå¤–éƒ¨æ•°æ®å¯¹æ¯”

å»ºè®®å®è·µé¡ºåºï¼š
1. æ¨¡ç³Šæµ‹è¯• â†’ 2. Gasä¼˜åŒ– â†’ 3. å•é“¾éƒ¨ç½² â†’ 4. å¤šé“¾äº¤äº’ â†’ 5. å…¨æµç¨‹æ¼”ç»ƒ