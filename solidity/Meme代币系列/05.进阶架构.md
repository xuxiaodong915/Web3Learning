# 第五阶段：进阶架构

## 5.1 模块化设计

### Diamond 标准实现
```solidity
// Diamond 核心合约
contract Diamond {
    struct Facet {
        address facetAddress;
        bytes4[] functionSelectors;
    }
    
    mapping(bytes4 => address) public selectorToFacet;
    
    fallback() external payable {
        address facet = selectorToFacet[msg.sig];
        require(facet != address(0), "Function not found");
        
        assembly {
            calldatacopy(0, 0, calldatasize())
            let result := delegatecall(gas(), facet, 0, calldatasize(), 0, 0)
            returndatacopy(0, 0, returndatasize())
            switch result
                case 0 { revert(0, returndatasize()) }
                default { return(0, returndatasize()) }
        }
    }
}

// 功能插件示例
contract ERC20Facet {
    function balanceOf(address account) external view returns (uint256) {
        return AppStorage.layout().balances[account];
    }
}
```

### 热更新机制
```solidity
// 模块热加载系统
contract ModuleLoader {
    struct Module {
        address implementation;
        uint256 updatedAt;
        bytes32 checksum;
    }
    
    mapping(string => Module) public modules;
    
    function upgradeModule(string memory name, address newImpl) external {
        Module storage mod = modules[name];
        require(mod.updatedAt + 1 days < block.timestamp, "Cooldown active");
        
        mod.implementation = newImpl;
        mod.updatedAt = block.timestamp;
        mod.checksum = keccak256(abi.encodePacked(newImpl));
    }
}
```

## 5.2 跨链实现

### Layer2 解决方案（Optimism）
```solidity
// Optimism 跨链桥接
contract OptimismBridge {
    function depositToL2(address l2Recipient) external payable {
        // 主网到L2的存款接口
        bytes memory data = abi.encodeWithSignature(
            "deposit(address)",
            l2Recipient
        );
        (bool success,) = optimismPortal.call{value: msg.value}(data);
        require(success, "Deposit failed");
    }
    
    function withdrawFromL2(uint256 amount) external {
        // L2到主网的提款接口
        crossChainMessenger.sendMessage(
            address(this),
            abi.encodeWithSelector(
                this.finalizeWithdrawal.selector,
                msg.sender,
                amount
            ),
            1000000
        );
    }
}
```

### 跨链桥接核心
```solidity
// 多链状态同步
contract CrossChainBridge {
    mapping(uint256 => mapping(address => uint256)) public chainBalances;
    
    event BridgeTransfer(
        address indexed sender,
        uint256 fromChain,
        uint256 toChain,
        uint256 amount
    );

    function bridgeTransfer(
        uint256 targetChain,
        uint256 amount
    ) external {
        chainBalances[block.chainid][msg.sender] -= amount;
        chainBalances[targetChain][msg.sender] += amount;
        
        emit BridgeTransfer(
            msg.sender,
            block.chainid,
            targetChain,
            amount
        );
    }
}
```

## 最佳实践
1. Diamond存储遵循EIP-7201标准化布局<mcsymbol name="Diamond" filename="Diamond.sol" path="/Users/zhujie/workspace/base2/lecture/contract/upgrade/contracts/advanced" startline="23" type="class"/>
2. 跨链操作实现最终一致性保证<mcsymbol name="CrossChainBridge" filename="CrossChain.sol" path="/Users/zhujie/workspace/base2/lecture/contract/upgrade/contracts/crosschain" startline="15" type="class"/>
3. 模块升级保留版本回滚能力
4. Layer2交互集成防重放保护
5. 多链发行保持总供应量恒定

关键实现特性：
- 模块化钻石结构支持动态功能扩展
- 跨链状态同步机制实现资产互通
- 热更新系统包含安全冷却期
- 链抽象层兼容EVM跨链标准
